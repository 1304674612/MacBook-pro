#!/usr/bin/env bash
# Pre-commit hook: è‹±æ–‡æ‹¼å†™æ£€æŸ¥ (ä»…æ£€æŸ¥ staged æ–‡ä»¶)
set -e

# é€‰æ‹© cspell æ‰§è¡Œå‘½ä»¤: ä¼˜å…ˆå…¨å±€, å…¶æ¬¡æœ¬åœ° node_modules, æœ€å npx --no-install
CSPELL_CMD=""
if command -v cspell &> /dev/null; then
  CSPELL_CMD="cspell"
elif [ -f "./node_modules/.bin/cspell" ]; then
  CSPELL_CMD="./node_modules/.bin/cspell"
elif command -v npx &> /dev/null; then
  CSPELL_CMD="npx --no-install cspell"
else
  echo "âš ï¸  cspell not found (global/local). Install: npm install (project) æˆ– npm install -g cspell"
  echo "Skipping spell check..."
  exit 0
fi

# è·å– staged æ–‡ä»¶ (ä»…æ–‡æœ¬ç±»æ–‡ä»¶)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|txt|java|c|cpp|h|py|js|ts|json|yaml|yml|sh)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No text files to spell-check"
  exit 0
fi

echo "ğŸ” Running spell check (using: $CSPELL_CMD) ..."
echo "$STAGED_FILES" | xargs $CSPELL_CMD --no-progress --no-must-find-files
RESULT=$?

if [ $RESULT -ne 0 ]; then
  echo ""
  echo "âŒ Spell check failed. Fix errors æˆ–æ·»åŠ å•è¯åˆ° .vscode/cspell.json / .vscode/cspell.json"
  echo "   è·³è¿‡æœ¬æ¬¡: git commit --no-verify"
  exit 1
fi

echo "âœ… Spell check passed"
exit 0
